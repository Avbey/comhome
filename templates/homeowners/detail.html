{% extends 'base.html' %}
{% load staticfiles %}
{% load render_table from django_tables2 %}
{% block title %} {{homeowner.name}} - Comfortable Home{% endblock %}
{% block breadcrumb %}
<div class="page-header">
        <h2 class="pageheader-title">Собственник {{homeowner.name}}</h2>
    <div class="page-breadcrumb">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li  class="breadcrumb-item"><a href="{% url 'homeowners:list' %}">Собственники</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{homeowner.name}}</li>
            </ol>
        </nav>
    </div>
</div>
{% endblock breadcrumb %}
{% block content %}
<div class="main_container" id="maincontainer">
  <div class="overview_form_block row marl justify-content-center">
    <div class="col-md-12">
    <div class="simple-card">
        <div class="card-header d-flex">
                <div class="toolbar ml-auto">
                    <a href="{% url 'homeowners:edit' homeowner.id %}" class="btn btn-light btn-sm"><i class="fas fa-pencil-alt"></i></a>
                    <a href="{% url 'homeowners:remove' homeowner.id %}" class="btn btn-light btn-sm"><i class="fas fa-trash-alt"></i></a>
                </div>
        </div>
        <ul class="nav nav-tabs" id="myTab5" role="tablist">
            <li class="nav-item">
                <a class="nav-link border-left-0 active show" id="main-information-tab" data-toggle="tab" href="#main-information" role="tab" aria-controls="home" aria-selected="true">Подробная информация</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="passport-information-tab" data-toggle="tab" href="#passport-information" role="tab" aria-controls="profile" aria-selected="false">Паспортные данные</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="additional-information-tab" data-toggle="tab" href="#additional-information" role="tab" aria-controls="contact" aria-selected="false">Дополнительная информация</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="activity-information-tab" data-toggle="tab" href="#activity-information" role="tab" aria-controls="contact" aria-selected="false">Обращения</a>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent5">
            <div class="tab-pane fade active show" id="main-information" role="tabpanel" aria-labelledby="home-tab-simple">
                <p>ФИО: {{ homeowner.name }} </p>
                <p>Пол: {{ homeowner.gender }}</p>
                <p>Дата рождения: {{ homeowner.birthday }}</p>
                <p>Номер телефона: {{ homeowner.phone }}</p>
                <p>Email: {{ homeowner.email }}</p>
                <p>Задолженность: {% if homeowner.debt %} Да {% else %} Нет {% endif %}</p>
                <p>Статус взыскания задолженности: {{ homeowner.status_of_work_with_debt }}</p>
                <p>Оплата мусора: {% if homeowner.garbage_payment %} Оплачено {% else %} Нет {% endif %}</p>

            </div>
            <div class="tab-pane fade" id="passport-information" role="tabpanel" aria-labelledby="profile-tab-simple">
                <p>Дата выдачи: {{ homeowner.passport_date }}</p>
                <p>Серия: {{ homeowner.passport_series }}</p>
                <p>Номер: {{ homeowner.passport_id }}</p>
                <p>Кем выдан: {{ homeowner.issued_by }}</p>
                <p>Код подразделения: {{ homeowner.unit_code }}</p>
                <p>Тип паспорта: {{ homeowner.type_of_passport }}</p>
                <p></p>
                <p></p>
            </div>
            <div class="tab-pane fade" id="additional-information" role="tabpanel" aria-labelledby="contact-tab-simple">
                <p>Напоминание о Дне Рождения: {% if homeowner.birthday_reminder %} Да {% else %} Нет {% endif %}</p>
                <p>Проблемный клиент: {% if homeowner.hard_case %} Да {% else %} Нет {% endif %}</p>
                <p>Лояльный: {% if homeowner.loyal %} Да {% else %} Нет {% endif %}</p>
                <p>VIP-клиент: {% if homeowner.vip %} Да {% else %} Нет {% endif %}</p>
                <p>Звонки: {% if homeowner.calls %} Да {% else %} Нет {% endif %}</p>
                <p>SMS: {% if homeowner.sms %} Да {% else %} Нет {% endif %}</p>
                <p>Email: {% if homeowner.mail %} Да {% else %} Нет {% endif %}</p>
                <p>Комментарий: {{ homeowner.comments }}</p>
            </div>
            <div class="tab-pane fade" id="activity-information" role="tabpanel" aria-labelledby="activity-tab-simple">
                {% render_table table %}
            </div>
        </div>
        <div class="card-footer  p-0 text-left d-flex justify-content-center">
                <div class="card-footer-item card-footer-item-bordered">
                Дата: {{ homeowner.created_on }}
                </div>
                <div class="card-footer-item card-footer-item-bordered">
                Добавил: {{ homeowner.created_by }}
                </div>
        </div>
    </div>

          </div>
        </div>

        <!-- Attachment Section start -->
      <div>
      <div class="card">
      <div class="card-body mar-top" id="datashow">
          <div class="card-title view-pad">
              <h5>Прикрепления</h5>
         </div>
          <div class="row marl">
              <div class="col-md-12">
                  <form id="attachment_form" method="POST" enctype="multipart/form-data">
                      <div class="form-group ">
                        <input type="file" class="form-control-file" cols="40" id="id_attachments" name="attachment">
                          <div><i id="AttachmentError" style="display:none; color:red"></i></div>
                          <br>
                          <div class="buttons_row">
                              <button class="btn btn-default save" style="text-align: center;" id="attachment_submit">Сохранить</button>
                          </div>
                      </div>
                      <input type="hidden" value="{{homeowner.id}}" name="homeownerid">
                  </form>
                  <ul class="list-group" id="attachment_div">
                      {% for attachemnt in attachments %}
                          <li class="list-group-item list-row" id="attachment{{attachemnt.id}}">
                              <div class="float-right right-container">
                                <div class="list-row-buttons btn-group float-right">
                                  <button  class="action btn btn-danger" onclick="remove_attachment({{attachemnt.id}})">Удалить</button>
                                </div>
                              </div>
                                <div class="stream-post-container" id="attachment_name{{attachemnt.id}}"><pre><a href="{{ attachemnt.attachment.url }}">{{ attachemnt.file_name }}</a></pre></div>
                              <div class="stream-container">
                                <pre class="float-left">{{ attachemnt.created_by }}</pre>
                                <pre class="float-right">{{ attachemnt.created_on }}</pre>
                              </div>
                          </li>
                      {% endfor %}
                  </ul>
              </div>
          </div>
      </div>
      </div>
        <!-- Attachment Section end -->

{#        <!-- Comments Section starts-->#}
{#      <div>#}
{#        <div class="card-body mar-top" id="datashow">#}
{#         <div class="card-title view-pad">#}
{#          <h5>Комментарий</h5>#}
{#        </div>#}
{#          <div class="row marl">#}
{#            <div class="col-md-12">#}
{#              <form id="comment_form" method="POST" enctype="multipart/form-data">#}
{#                <div class="form-group ">#}
{#                  <textarea class="form-control" textarea cols="40" rows="3" id="id_comments" name="comment" placeholder="Напишите свой комментарий тут"></textarea><div><i id="CommentError" style="display:none; color:red"></i></div>#}
{#                  </br>#}
{#                  <div class="buttons_row">#}
{#                  <button class="btn btn-default save" style="text-align: center;" id="comment_submit">Submit</button>#}
{#                  </div>#}
{#                </div>#}
{#                <input type="hidden" value="{{homeowner.id}}" name="homeownerid">#}
{#              </form>#}
{#              <ul class="list-group" id="comments_div">#}
{#                {% for comment in comments %}#}
{#                <li class="list-group-item list-row" id="comment{{comment.id}}">#}
{#                  <div class="float-right right-container">#}
{#                    <div class="list-row-buttons btn-group float-right">#}
{#                      <button class="btn btn-link btn-sm dropdown-toggle" data-toggle="dropdown" type="button"><span class="caret"></span></button>#}
{#                      <ul class="dropdown-menu text-center">#}
{#                        <li>#}
{#                          <a class="action" onclick="edit_comment({{comment.id}})">Редактировать</a>#}
{#                        </li>#}
{#                        <li>#}
{#                          <a class="action" onclick="remove_comment({{comment.id}})">Удалить</a>#}
{#                        </li>#}
{#                      </ul>#}
{#                    </div>#}
{#                  </div>#}
{#                  <div class="stream-post-container" id="comment_name{{comment.id}}"><pre>{{ comment.comment }}</pre></div>#}
{#                  <div class="stream-container">#}
{#                    <pre class="float-left">{{ comment.commented_by }}</pre>#}
{#                    <pre class="float-right">{{ comment.commented_on }}</pre>#}
{#                  </div>#}
{#                </li>#}
{#                {% endfor %}#}
{#              </ul>#}
{#            </div>#}
{#          </div>#}
{#          <div class="modal fade" id="Comments_homeowners_Modal" role="dialog" data-keyboard="false" data-backdrop="static">#}
{#            <div class="modal-dialog modal-lg">#}
{#              <div class="modal-content">#}
{#                <div class="modal-header">#}
{#                  <h4 class="modal-title">Обновить комментарий</h4>#}
{#                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>#}
{##}
{#                </div>#}
{#                <form id="comment_edit_form" method="POST" >#}
{#                  <div class="modal-body">#}
{#                    <div class="form-group">#}
{#                      <textarea class="form-control" textarea cols="40" rows="3" id="id_editcomment" name="comment" placeholder="Submit Your Comments"></textarea><span><i id="CommentEditError" style="display:none; color:red"></i></span>#}
{#                      <input type="hidden" value="{{ homeowner.id }}" name="homeownerid">#}
{#                      <input type="hidden" value="" name="commentid" id="commentid">#}
{#                    </div>#}
{#                  </div>#}
{#                  <div class="modal-footer">#}
{#                    <button class="btn btn-default save" id="comment_edit" type="submit">Update</button>#}
{#                  </div>#}
{#                </form>#}
{#              </div>#}
{#            </div>#}
{#          </div>#}
{#        </div></div>#}
{#        <!-- Comments Section Ends-->#}
        </div>
        </div>
{% endblock %}

{% block js_block %}
 <script type="text/javascript">
  function resetForm() {
    $('#CommentEditError').hide()
    document.getElementById("CommentEditError").reset();
    }

$("#comment_form").submit(function (e) {
  e.preventDefault()
    const formData = new FormData($("#comment_form")[0]);
    $.ajax({
    url: "{% url 'homeowners:add_comment' %}",
    type: "POST",
    data: formData,
    cache: false,
    contentType: false,
    processData: false,
    success: function (data) {
      if (data.error) {
        $("#CommentError").html(data.error).show()
      } else {
        d = new Date(data.commented_on);
        $("#comments_div").prepend("<li class='list-group-item list-row' id='comment" + data.comment_id + "'>" +
          "<div class='float-right right-container'>" +
          "<div class='list-row-buttons btn-group float-right'>" +
          "<button class='btn btn-link btn-sm dropdown-toggle' data-toggle='dropdown' type='button'><span class='caret'></span></button>" +
          "<ul class='dropdown-menu text-center'>" +
          "<li><a class='action' onclick='edit_comment(" + data.comment_id + ")'>Edit</a></li>" +
          "<li><a class='action' onclick='remove_comment(" + data.comment_id + ")''>Remove</a></li></ul></div></div>" +
          "<div class='stream-post-container' id='comment_name"+data.comment_id+"'><pre>"+data.comment+"</pre></div>"+
          "<div class='stream-container'><pre class='float-left'>"+data.commented_by+"</pre><pre class='float-right'>"+d.toGMTString()+"</pre></div>"+
          "<div class='stream-date-container' id='comment_file_div"+data.comment_id+"'><div id='new_comment"+data.comment_id+"'</div></div></li>"
        );
        $("#id_comments").val("")
        alert("Comment Submitted")
        $("#CommentError").html("")
      }
    }
  })
});

function edit_comment(x) {
  $('#Comments_homeowners_Modal').modal('show');
  comment = $("#comment_name" + x).text()
  $("#commentid").val(x)
  $("#id_editcomment").val(comment)
}

$("#comment_edit").click(function (e) {
  e.preventDefault()
    const formData = new FormData($("#comment_edit_form")[0]);
    $.ajax({
    url: "{% url 'homeowners:edit_comment' %}",
    type: "POST",
    data: formData,
    cache: false,
    contentType: false,
    processData: false,
    success: function (data) {
      if (data.error) {
        $("#CommentEditError").html(data.error).show()
      } else {
        $("#comment_name" + data.commentid).html('<pre>' + data.comment + '</pre>')
        $('#Comments_homeowners_Modal').modal('hide');
        $("#id_editcomment").val("")
        $("#CommentEditError").html("")
      }
    }
  })
});

function HideError(e) {
    $("#CommentError").hide()
  $("#AttachmentError").hide()
}

function remove_comment(x) {
    const con = confirm("Do you want to Delete it for Sure!?");
    if (con == true) {
    $.post('{% url "homeowners:remove_comment" %}', {
      "comment_id": x
    }, function (data) {
      if (data.error) {
        alert(data.error)
      } else {
        $("#comment" + data.cid).remove()
      }
    })
  }
}

$("#attachment_form").submit(function (e) {
  e.preventDefault()
    const formData = new FormData($("#attachment_form")[0]);
    $.ajax({
    url: "{% url 'homeowners:add_attachment' %}",
    type: "POST",
    data: formData,
    cache: false,
    contentType: false,
    processData: false,
    success: function (data) {
        alert("Attachment Saved")
      if (data.error) {
        $("#AttachmentError").html(data.error).show()
      alert("Attachment Saved")
      } else {
        $("#attachment_div").prepend(
            "<li class='list-group-item list-row' id='attachment" + data.attachment_id + "'>" +
              "<div class='float-right right-container'><div class='list-row-buttons btn-group float-right'><button class='action btn btn-danger' onclick='remove_attachment("+data.attachment_id+")''>Remove</button></div></div>" +
              "<div class='stream-post-container' id='comment_name"+data.attachment_id+"'><pre><a href='"+data.attachment_url+"'>"+data.attachment+"</a></pre></div>"+
              "<div class='stream-container'><pre class='float-left'>"+data.created_by+"</pre><pre class='float-right'>"+data.created_on+"</pre></div>" +
            "</li>"
        );
        $("#id_attachments").val("")
        alert("Attachment Saved")
        $("#AttachmentError").html("")
      }
    }
  })
});


function remove_attachment(x) {
    const con = confirm("Do you want to Delete it for Sure!?");
    if (con == true) {
    $.post('{% url "homeowners:remove_attachment" %}', {
      "attachment_id": x
    }, function (data) {
      if (data.error) {
        alert(data.error)
      } else {
        $("#attachment" + data.aid).remove()
      }
    })
  }
}

</script>
{% endblock js_block %}
